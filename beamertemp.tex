\usepackage{multicol,hanging,ifluatex}%
\usecolortheme{lily}%
\mathversion{bold}%
\newif\ifnotoc\notocfalse%
\newcommand{\notoc}{\notoctrue}%
\newif\ifnosubtoc\nosubtocfalse%
\newcommand{\nosubtoc}{\nosubtoctrue}%
%%%%% {{{
\makeatletter%
\ifluatex\else%
	\newlength\zw%
	\zw=1zw\relax%
\fi%
\newcounter{tocpage}%
\newif\ifnofooter\nofootertrue%
\newcommand{\switchfooter}{\ifnofooter\nofooterfalse\else\nofootertrue\fi}%
\newif\ifnoheader\noheadertrue%
\newcommand{\switchheader}{\ifnoheader\noheaderfalse\else\noheadertrue\fi}%
\newif\ifnosubheader\nosubheadertrue%
\newcommand{\switchsubheader}{\ifnosubheader\nosubheaderfalse\else\nosubheadertrue\fi}%
\renewcommand{\title}{\@dblarg\beamer@title}%
\long\def\beamer@title[#1]#2{%
	\def\thetitle{#2}%
	\def\inserttitle{#2}%
	\def\beamer@shorttitle{#1}%
}%
\def\maketitle{\ifbeamer@inframe\titlepage\else\frame{\titlepage}\fi\nofooterfalse}%
\renewcommand{\footnoterule}{}%
\def\@makefnmark{\hbox{\@textsuperscript{{\usebeamercolor[fg]{footnote mark}\usebeamerfont*{footnote mark}{*\@thefnmark}}}}}%
\def\inserttotaltocpage{0\relax}%
\AtEndDocument{%
	\clearpage%
	\beamer@tempcount=\c@page\advance\beamer@tempcount by -1%
	\if@filesw%
		\immediate\write\@auxout{\string\@writefile{nav}%
		{\noexpand\headcommand{\noexpand\def\noexpand\inserttotaltocpage{\thetocpage}}}}%
	\fi%
}%
\makeatother%
%%%%% }}}
%%%%% {{{
\newcommand\frametitlesec{\frametitle{\insertsectionhead}}
\newcommand\frametitlesubs{\frametitle{\insertsubsectionhead}}
%%%%% {{{
\newcounter{currentwotocframenumber}%
\newcounter{wotoctotalframenumber}%
\setbeamerfont{frametitle}{size=\footnotesize,family=\rmfamily}%
\setbeamerfont{section in toc}{family=\rmfamily}%
\setbeamerfont{subsection in toc}{family=\rmfamily}%
\setbeamercolor{section in head/foot}{fg=blue}%
\setbeamercolor{subsection in head/foot}{fg=blue}%
\setbeamercolor{footline}{fg=gray}%
\setbeamercolor{frametitle}{fg=green}%
\setbeamercolor{headline}{fg=blue}%
\setbeamercolor{subheadline}{fg=gray}%
\setbeamertemplate{navigation symbols}{}%
% \addtobeamertemplate{footline}{}{\vspace*{3\zw}}%
%%%%% }}}
%%%%% {{{
\setbeamertemplate{footnote}{%
	\tiny%
	\makebox[2em][l]{\insertfootnotemark}\hspace{-.7\zw}\insertfootnotetext%
}%
\setbeamertemplate{frametitle}{%
	\begin{beamercolorbox}{frametitle}%
		\hfill\hbox{{\large$\bullet$\insertframetitle}}%
	\end{beamercolorbox}%
}%
\setbeamertemplate{footline}{%
	\leavevmode%
	\vspace{1\zw}
	\begin{beamercolorbox}{footline}%
		\tiny%
		\hspace{.4\zw}\hbox{\ifnofooter\else\insertsectionhead\ifx\insertsubsectionhead\empty\else{}.\insertsubsectionhead\fi\fi}%
		\setcounter{wotoctotalframenumber}{\inserttotalframenumber}%
		\addtocounter{wotoctotalframenumber}{-\inserttotaltocpage}%
		\addtocounter{wotoctotalframenumber}{-1}%
		\setcounter{currentwotocframenumber}{\theframenumber}%
		\addtocounter{currentwotocframenumber}{-1}%
		\addtocounter{currentwotocframenumber}{-\thetocpage}%
		\hfill\hbox{\ifnofooter\else\thecurrentwotocframenumber/\thewotoctotalframenumber\fi\hspace{.8\zw}}%
	\end{beamercolorbox}%
}%
\setbeamertemplate{headline}{%
	\begin{beamercolorbox}{headline}%
		\centering\hbox{\ifnoheader\else\large\thetitle\fi}%
	\end{beamercolorbox}%
	\begin{beamercolorbox}{subheadline}%
		\centering\hbox{\ifnosubheader\else\large\thetitle\fi}%
	\end{beamercolorbox}%
}%
\addtobeamertemplate{headline}{\vspace*{1\zw}}{}%
%%%%% }}}
%%%%% {{{
\AtBeginSection[]{%
	\ifnotoc\else%
		\switchfooter%
		\switchheader
		\begin{frame}<beamer>%
			\begin{multicols}{2}%
				\tableofcontents[currentsection,sectionstyle=show/shaded,subsectionstyle=show/shaded]%
			\end{multicols}%
		\end{frame}%
		\stepcounter{tocpage}%
		\switchfooter%
		\switchheader
	\fi%
}%
\AtBeginSubsection[]{%
	\ifnotoc\else\ifnosubtoc\else%
		\switchfooter%
		\switchsubheader%
		\begin{frame}<beamer>%
			\begin{multicols}{2}%
				\tableofcontents[currentsubsection,sectionstyle=show/shaded,subsectionstyle=show/shaded]%
			\end{multicols}%
		\end{frame}%
		\stepcounter{tocpage}%
		\switchfooter%
		\switchsubheader%
	\fi\fi%
}%
%%%%% }}}
